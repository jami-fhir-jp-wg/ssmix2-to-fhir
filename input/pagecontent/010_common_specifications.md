<!-- common_specifications.md {% comment %}
*****************************************************************************************
*
* マッピング共通仕様 
*
*****************************************************************************************
{% endcomment %} -->

<style type="text/css">
table {
    border-collapse: collapse;
}
table, th, td {
    border: 1px solid gray;
}
</style>

このセクションでは、このガイドラインで使用されるすべてに共通する重要な定義、解釈、および要件の概要を説明する。

<br/>

### SS-MIX2のバージョン
* このガイドラインは 1.2g 以降を想定する。<br/>
* 現時点では標準化ストレージとトランザクションストレージを対象とする。<br/>
<br/>

### 文字コード
* SS-MIX2の標準化ストレージは「ISO-2022-JP」を符号化表現として採用しているが、このガイドラインで定義する出力（例えば、サーバ応答としてのFHIRリソースなど）は文字コードとしてUnicodeを用い，UTF-8で符号化されることを前提としている。<br/>
<br/>

### ロジカルIDの採番
リソースの新規作成のためにupdateインタラクション（create-update）を用いる場合のロジカルIDの採番方法について説明する。<br/>

* ロジカルIDに用いる項目は原則、標準化ストレージのディレクトリ名, ファイル名, ファイルの内容, INDEXDB, SS-MIXヘッダから取得し、それらを結合したものを元に生成することを推奨する。<br/>
* ロジカルIDは（1件の）リソースの元となったセグメントや要素が機械的に特定できるよう、生成（もしくはシステムで管理）しなければならない。また、[A-Za-z0-9\-\.]{1,64} を満たさなければならない。<br/>
* Bundleの場合、MSH-10 メッセージ制御IDの採用も考えられる。<br/>

採番への使用が想定される項目とその取り得る値は下表の通りである。<br/>

| 取得元 | 項目 | 最大桁数 | 備考 |
| :--- | :--- | :--- | :--- 
| INDEXDB / SS-MIXヘッダ | 医療施設ID | 10 |  |
| ファイル名 / SS-MIXヘッダ | 患者ID | 15 |  |
| ファイル名 / SS-MIXヘッダ | 診療日 | 8 | yyyyMMdd |
| ファイル名 / SS-MIXヘッダ | データ種別 | 5 | SS-MIX2のデータ種別を用いなくてもよい。用いない場合はSS-MIX2のデータ種別とローカルシステムのデータ種別が「等しく（equal）」なければならない。 |
| ファイル名 / SS-MIXヘッダ | オーダ番号 | 15 |  |
| ファイル名 / SS-MIXヘッダ | 発生日時 | 17 | [yy]yyMMddHHmmssfff（※頭3-4桁を省略）。FHIRサーバに対してdelete（削除）を送信する場合、「データが有効な際の更新日付」を設定しなければならない。 |
| ファイル名 / SS-MIXヘッダ | 診療科コード | 3 | 診療科コードはSS-MIX2の「使用者定義表-#0069 診療部門」を想定し、3桁としている。 |
| HL7V2メッセージ | セグメントタイプ | 3 | 各セグメントの0番目の値（MSH, PID など） |
| HL7V2メッセージ | 連番 | 3 | メッセージ内のセグメント番号（MSHを0とした連番） |
| HL7V2メッセージ | リソース識別子 | 64 | 1つのセグメントから、複数のリソースが生成される場合などに使用するリソースを特定するための識別子。ロジカルIDの生成には複数のリソース識別子を用いてもよい。 |

<br/>

#### ロジカルIDの採番例
##### ADT-00（患者基本情報）から生成した Patient
* 採番方法<br/>
[患者ID].[データ種別]<br/>
※ サーバサイドの自動付番で数値のみを使用している場合などにエラーとなる場合があるため、データ種別を末尾に設定している。<br/>

* 例<br/>
0001014360.ADT-00<br/>

##### OMP-01（処方オーダ）から生成した Patient
* 採番方法<br/>
[患者ID].[診療日].OMP-01.[オーダ番号].[発生日時(yyyMMddHHmmssfff)].[連番]<br/>
※ 「処方オーダ登録時点」のデータであることが考えられるため、ADT-00から発生したものと区別している。<br/>

* 例<br/>
0001014360.20210501.OMP-01.000000002988314.210501040510231.1<br/>

##### OMP-01（処方オーダ）から生成した Bundle
* 採番方法<br/>
[患者ID].[診療日].OMP-01.[オーダ番号].[発生日時(yyyMMddHHmmssfff)]<br/>

* 例<br/>
0001014360.20210501.OMP-01.000000002988314.210501040510231<br/>

##### OMP-01（処方オーダ）のRXEから生成した MedicationRequest
* 採番方法<br/>
 [患者ID].[診療日].OMP-01.[オーダ番号].[連番]<br/>

* 例<br/>
0001014360.20210501.OMP-01.000000002988314.210501040510231.004<br/>

* 例<br/>
0001014360.20210501.omp01.000000002988314.20210501040510231.4<br/>

##### OMP-01（処方オーダ）のORCから生成した Practitioner
* 採番方法（内部参照を想定）<br/>
[リソース識別子].[リソース識別子]<br/>

* 例<br/>
practitioner.ishi01<br/>
「ishi01」はORC-10などから取得した電子カルテの利用者コードを想定している。<br/>

<br/>
